#!/usr/bin/env python3
# -*- coding: utf-8 -*-
#
# Copyright 2014 CÃ©dric Picard
#
# LICENSE
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <http://www.gnu.org/licenses/>.
# END_OF_LICENSE
#
"""
Simple command line browser independant bookmark utility.

Usage: bm [options] [-r] URL TAG...
       bm [options]  -d  URL
       bm [options]  -l  [TAG]...
       bm [options]  -L  TAG...
       bm [options]  URL
       bm [options]  -t

Arguments:
    URL     The url to bookmark
            If alone, print the tags associated with URL
            If the url corresponds to an existing file,
            the absolute path is substituted to URL
            If URL is '-', then the program looks for a list of URL
            comming from the standard input.
    TAG     The tags to use with the url.

Options:
    -h, --help          Print this help and exit
    -r, --remove        Remove TAG from URL
    -d, --delete        Delete an url from the database
    -l, --list-every    List the urls with every of TAG
                        If no tag is given, list all urls
    -L, --list-any      List the urls with any of TAG
    -f, --file FILE     Use FILE as the database
                        Default is ~/.bookmarks
    -t, --tags          List every tag present in the database
    -n, --no-path-subs  Disable file path substitution
    --version           Print current version number
"""

VERSION = "1.0.4"

import os
import msgpack
from docopt import docopt


def add(database, url, tags):
    if url in database:
        for tag in tags:
            database[url].append(tag)
    else:
        database[url] = list(tags)


def remove(database, url, tags):
    try:
        for tag in tags:
            database[url].remove(tag)

        if database[url] == []:
            database.pop(url)
    except ValueError:
        pass


def delete(database, url):
    try:
        database.pop(url)
    except KeyError:
        pass


def list_any(database, tags):
    for url in database:
        if set(tags).intersection(set(database[url])) != set() or tags == []:
            yield url


def list_every(database, tags):
    for url in database:
        if set(tags).issubset(set(database[url])):
            yield url


def list_every_tags(database):
    result = set()
    for each in database:
        result = result.union(set(database[each]))
    return result


def manage_urls(urls, tags, d_file, database, args):
    if args["--delete"]:
        for url in urls:
            delete(database, url)
        msgpack.dump(database, open(d_file, 'wb'))

    elif args["--list-any"]:
        for url in urls:
            result = list(list_any(database, tags))
            result.sort()

            for each in result:
                print(each)

    elif args["--list-every"]:
        for url in urls:
            result = list(list_every(database, tags))
            result.sort()

            for each in list_every(database, tags):
                print(each)

    elif args["--remove"]:
        for url in urls:
            remove(database, url, tags)
        msgpack.dump(database, open(d_file, 'wb'))

    elif args["--tags"]:
        result = list(list_every_tags(database))
        result.sort()
        for tag in result:
            print(tag)

    elif args["TAG"]:
        for url in urls:
            add(database, url, tags)
        msgpack.dump(database, open(d_file, 'wb'))

    else:
        for url in urls:
            for tag in database[url]:
                print(tag)


def main():
    args = docopt(__doc__, version=VERSION)

    if args["URL"] == '-':
        urls = os.sys.stdin.read().splitlines()
    else:
        urls = [ args["URL"] ]

    d_file = args["--file"] or os.environ["HOME"] + "/.bookmarks"
    try:
        if not os.path.exists(d_file):
            print('The file "' + d_file + '" does not exists: creating it.',
                    file=os.sys.stderr)
            open(d_file, "a+").close()

        database = msgpack.load(open(d_file, "rb"), encoding="utf-8")

    except msgpack.exceptions.UnpackValueError:
        database = {}

    except PermissionError as e:
        os.sys.exit(e)

    tags = args["TAG"]

    if not args["--no-path-subs"] and urls != [ None ]:
        lst = []
        for url in urls:
            url = str(url)
            if os.path.exists(url):
                lst.append(os.path.abspath(url))
            else:
                lst.append(url)

    manage_urls(urls, tags, d_file, database, args)


if __name__ == "__main__":
    try:
        main()
    except KeyError as e:
        print("No such bookmark:", e, file=os.sys.stderr)
        os.sys.exit(1)
